<main>
  <!-- Event Hero Section -->
  <section style="padding: 120px 0 80px; background: linear-gradient(135deg, var(--primary) 0%, #667eea 100%); color: white; position: relative; overflow: hidden;">
    <div class="container relative z-10">
      <!-- Event Type Badge -->
      <div class="mb-4">
        <span class="event-type-badge" style="background: rgba(255, 255, 255, 0.2); color: white; padding: 0.5rem 1rem; border-radius: 100px; font-size: 0.875rem; font-weight: 600;">
          {{ eventTypeEmoji }} {{ eventTypeLabel }}
        </span>
      </div>
      
      <!-- Event Title -->
      <h1 class="font-bold mb-6 animate-fade-in" style="font-family: 'Google Sans', sans-serif; font-size: clamp(2.5rem, 6vw, 4rem); line-height: 1.1;">
        {{ title }}
      </h1>
      
      <!-- Quick Info -->
      <div class="flex flex-wrap gap-6 mb-6" style="font-size: 1.125rem;">
        <div class="flex items-center gap-2">
          <span class="material-icons-round">schedule</span>
          <span id="eventDateTime">{{ date }}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="material-icons-round">place</span>
          <span id="eventLocation">{{ location.venue }}</span>
        </div>
        {% if capacity %}
        <div class="flex items-center gap-2">
          <span class="material-icons-round">people</span>
          <span>{{ capacity }} spots</span>
        </div>
        {% endif %}
      </div>
      
      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-4">
        {% if registrationRequired and registrationLink %}
        <a href="{{ registrationLink }}" target="_blank" class="btn inline-flex items-center gap-2" style="background: white; color: var(--primary); padding: 1rem 2rem; font-size: 1.125rem; border-radius: 100px; font-weight: 600;">
          <span class="material-icons-round">how_to_reg</span>
          <span>Register Now</span>
        </a>
        {% endif %}
        
        <button id="addToCalendarBtn" class="btn inline-flex items-center gap-2" style="background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; padding: 1rem 2rem; font-size: 1.125rem; border-radius: 100px; font-weight: 600;">
          <span class="material-icons-round">event</span>
          <span>Add to Calendar</span>
        </button>
        
        <button id="shareBtn" class="btn inline-flex items-center gap-2" style="background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; padding: 1rem 2rem; font-size: 1.125rem; border-radius: 100px; font-weight: 600;">
          <span class="material-icons-round">share</span>
          <span>Share</span>
        </button>
      </div>
    </div>
    
    <!-- Decorative Background -->
    <div style="position: absolute; top: 0; right: 0; width: 50%; height: 100%; opacity: 0.1; background: radial-gradient(circle, white 1px, transparent 1px); background-size: 50px 50px;"></div>
  </section>
  
  <!-- Event Details Section -->
  <section style="padding: 80px 0;">
    <div class="container">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <!-- Description -->
          <div class="mb-12">
            <h2 class="text-3xl font-bold mb-6" style="font-family: 'Google Sans', sans-serif; color: var(--text);">
              About This Event
            </h2>
            <div class="prose prose-lg" style="color: var(--text); line-height: 1.8;">
              {{ fullDescription or description }}
            </div>
          </div>
          
          <!-- Speakers -->
          {% if speakers and speakers.length > 0 %}
          <div class="mb-12">
            <h2 class="text-3xl font-bold mb-6" style="font-family: 'Google Sans', sans-serif; color: var(--text);">
              Speakers
            </h2>
            <div class="space-y-6">
              {% for speaker in speakers %}
              <div class="flex gap-4 p-6 rounded-xl" style="background: var(--bg-secondary);">
                {% if speaker.photoUrl %}
                <img src="{{ speaker.photoUrl }}" alt="{{ speaker.name }}" class="w-20 h-20 rounded-full object-cover">
                {% else %}
                <div class="w-20 h-20 rounded-full flex items-center justify-center" style="background: var(--primary); color: white; font-size: 2rem; font-weight: 600;">
                  {{ speaker.name[0] }}
                </div>
                {% endif %}
                <div>
                  <h3 class="text-xl font-bold mb-1" style="font-family: 'Google Sans', sans-serif; color: var(--text);">
                    {{ speaker.name }}
                  </h3>
                  <p class="mb-2" style="color: var(--primary); font-weight: 600;">
                    {{ speaker.title }}{% if speaker.company %} ‚Ä¢ {{ speaker.company }}{% endif %}
                  </p>
                  {% if speaker.bio %}
                  <p style="color: var(--text); opacity: 0.7;">{{ speaker.bio }}</p>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div>
          <!-- Event Info Card -->
          <div class="event-card sticky top-8">
            <div style="padding: 2rem;">
              <h3 class="text-xl font-bold mb-6" style="font-family: 'Google Sans', sans-serif; color: var(--text);">
                Event Information
              </h3>
              
              <div class="space-y-4">
                <!-- Date & Time -->
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons-round" style="color: var(--primary);">schedule</span>
                    <span class="font-semibold" style="color: var(--text);">Date & Time</span>
                  </div>
                  <p id="sidebarDateTime" style="color: var(--text); opacity: 0.7; padding-left: 2rem;">
                    {{ date }}
                  </p>
                </div>
                
                <!-- Location -->
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons-round" style="color: var(--primary);">place</span>
                    <span class="font-semibold" style="color: var(--text);">Location</span>
                  </div>
                  {% if location.isVirtual %}
                  <p style="color: var(--text); opacity: 0.7; padding-left: 2rem;">
                    üåê Virtual Event<br>
                    {% if location.virtualLink and registrationRequired == false %}
                    <a href="{{ location.virtualLink }}" target="_blank" style="color: var(--primary); text-decoration: underline;">Join Meeting</a>
                    {% else %}
                    Link provided after registration
                    {% endif %}
                  </p>
                  {% else %}
                  <p style="color: var(--text); opacity: 0.7; padding-left: 2rem;">
                    {{ location.venue }}<br>
                    {% if location.room %}{{ location.room }}<br>{% endif %}
                    {% if location.address %}{{ location.address }}{% endif %}
                  </p>
                  {% endif %}
                </div>
                
                <!-- Capacity -->
                {% if capacity %}
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons-round" style="color: var(--primary);">people</span>
                    <span class="font-semibold" style="color: var(--text);">Capacity</span>
                  </div>
                  <p style="color: var(--text); opacity: 0.7; padding-left: 2rem;">
                    {{ capacity }} attendees maximum
                  </p>
                </div>
                {% endif %}
                
                <!-- Tags -->
                {% if tags and tags.length > 0 %}
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons-round" style="color: var(--primary);">label</span>
                    <span class="font-semibold" style="color: var(--text);">Topics</span>
                  </div>
                  <div class="flex flex-wrap gap-2" style="padding-left: 2rem;">
                    {% for tag in tags %}
                    <span style="background: var(--bg-secondary); color: var(--text); padding: 0.25rem 0.75rem; border-radius: 100px; font-size: 0.875rem;">
                      {{ tag }}
                    </span>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              </div>
              
              <div class="mt-8 pt-6" style="border-top: 1px solid var(--border);">
                <a href="/events/" class="flex items-center gap-2" style="color: var(--primary); font-weight: 600;">
                  <span class="material-icons-round">arrow_back</span>
                  <span>Back to All Events</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  // Event data for calendar functionality
  const eventData = {
    title: {{ title | dump | safe }},
    description: {{ description | dump | safe }},
    location: {{ location | dump | safe }},
    date: {{ date | dump | safe }},
    endDate: {{ endDate | dump | safe }},
    eventType: {{ eventType | dump | safe }}
  };
  
  // Format date display
  function formatEventDate(dateString, endDateString) {
    const date = new Date(dateString);
    const options = {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      timeZoneName: 'short'
    };
    
    let formatted = date.toLocaleDateString('en-US', options);
    
    if (endDateString) {
      const endDate = new Date(endDateString);
      const endTime = endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      formatted += ` - ${endTime}`;
    }
    
    return formatted;
  }
  
  // Update date displays
  document.addEventListener('DOMContentLoaded', function() {
    const formatted = formatEventDate(eventData.date, eventData.endDate);
    const dateTimeEl = document.getElementById('eventDateTime');
    const sidebarDateTimeEl = document.getElementById('sidebarDateTime');
    if (dateTimeEl) dateTimeEl.textContent = formatted;
    if (sidebarDateTimeEl) sidebarDateTimeEl.textContent = formatted;
  });
  
  // Add to Calendar functionality with multiple options
  document.getElementById('addToCalendarBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    
    const startDate = new Date(eventData.date);
    const endDate = eventData.endDate ? new Date(eventData.endDate) : new Date(startDate.getTime() + 60 * 60 * 1000); // +1 hour default
    
    // Format dates for different calendar services
    const formatDateForGoogle = (date) => {
      return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    };
    
    const location = eventData.location.isVirtual 
      ? 'Virtual Event' 
      : `${eventData.location.venue || ''}${eventData.location.room ? ', ' + eventData.location.room : ''}`;
    
    // Create a dropdown menu for calendar options
    const existingMenu = document.getElementById('calendarDropdown');
    if (existingMenu) {
      existingMenu.remove();
      return;
    }
    
    const dropdown = document.createElement('div');
    dropdown.id = 'calendarDropdown';
    dropdown.style.cssText = `
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      padding: 8px;
      margin-top: 8px;
      min-width: 200px;
      z-index: 1000;
    `;
    
    // Google Calendar link
    const googleStart = formatDateForGoogle(startDate);
    const googleEnd = formatDateForGoogle(endDate);
    const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventData.title)}&dates=${googleStart}/${googleEnd}&details=${encodeURIComponent(eventData.description)}&location=${encodeURIComponent(location)}`;
    
    // Outlook.com link
    const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(eventData.title)}&startdt=${startDate.toISOString()}&enddt=${endDate.toISOString()}&body=${encodeURIComponent(eventData.description)}&location=${encodeURIComponent(location)}`;
    
    // Office 365 link
    const office365Url = `https://outlook.office.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(eventData.title)}&startdt=${startDate.toISOString()}&enddt=${endDate.toISOString()}&body=${encodeURIComponent(eventData.description)}&location=${encodeURIComponent(location)}`;
    
    // Yahoo Calendar link
    const yahooStart = formatDateForGoogle(startDate);
    const yahooEnd = formatDateForGoogle(endDate);
    const yahooUrl = `https://calendar.yahoo.com/?v=60&title=${encodeURIComponent(eventData.title)}&st=${yahooStart}&et=${yahooEnd}&desc=${encodeURIComponent(eventData.description)}&in_loc=${encodeURIComponent(location)}`;
    
    // Create menu items
    const menuItems = [
      { name: 'Google Calendar', url: googleUrl, icon: 'üìÖ' },
      { name: 'Outlook.com', url: outlookUrl, icon: 'üìß' },
      { name: 'Office 365', url: office365Url, icon: 'üè¢' },
      { name: 'Yahoo Calendar', url: yahooUrl, icon: 'üìÜ' },
      { name: 'Download .ics file', action: 'download', icon: 'üíæ' }
    ];
    
    menuItems.forEach((item, index) => {
      const menuItem = document.createElement('a');
      menuItem.style.cssText = `
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: #1f2937;
        text-decoration: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      `;
      menuItem.innerHTML = `<span>${item.icon}</span><span>${item.name}</span>`;
      
      if (item.action === 'download') {
        menuItem.addEventListener('click', (e) => {
          e.preventDefault();
          downloadICS();
          dropdown.remove();
        });
      } else {
        menuItem.href = item.url;
        menuItem.target = '_blank';
        menuItem.addEventListener('click', () => {
          setTimeout(() => dropdown.remove(), 100);
        });
      }
      
      menuItem.addEventListener('mouseenter', () => {
        menuItem.style.background = '#f3f4f6';
      });
      menuItem.addEventListener('mouseleave', () => {
        menuItem.style.background = 'transparent';
      });
      
      dropdown.appendChild(menuItem);
    });
    
    // Position dropdown near the button
    const btnRect = this.getBoundingClientRect();
    dropdown.style.left = btnRect.left + 'px';
    dropdown.style.top = (btnRect.bottom + window.scrollY) + 'px';
    
    document.body.appendChild(dropdown);
    
    // Close dropdown when clicking outside
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target) && e.target !== this) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 0);
    
    // Download ICS file function
    function downloadICS() {
      const formatDate = (date) => {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };
      
      const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Job Club NJIT//Events//EN
BEGIN:VEVENT
UID:${Date.now()}@jobclub.njit.edu
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:${eventData.title}
DESCRIPTION:${eventData.description}
LOCATION:${location}
STATUS:CONFIRMED
END:VEVENT
END:VCALENDAR`;
      
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = `${eventData.title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  });
  
  // Share functionality
  document.getElementById('shareBtn')?.addEventListener('click', async function() {
    const shareData = {
      title: eventData.title,
      text: eventData.description,
      url: window.location.href
    };
    
    if (navigator.share) {
      try {
        await navigator.share(shareData);
      } catch (err) {
        console.log('Share cancelled or failed:', err);
      }
    } else {
      // Fallback: copy link
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Event link copied to clipboard!');
      });
    }
  });
</script>

<style>
  .prose {
    max-width: none;
  }
  
  .prose p {
    margin-bottom: 1.25rem;
  }
  
  .prose ul, .prose ol {
    margin: 1.25rem 0;
    padding-left: 1.5rem;
  }
  
  .prose li {
    margin-bottom: 0.5rem;
  }
</style>
